<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>Calendar - JobScheduler</title>
<!--
/********************************************************* begin of preamble
**
** Copyright (C) 2003-2012 Software- und Organisations-Service GmbH. 
** All rights reserved.
**
** This file may be used under the terms of either the 
**
**   GNU General Public License version 2.0 (GPL)
**
**   as published by the Free Software Foundation
**   http://www.gnu.org/licenses/gpl-2.0.txt and appearing in the file
**   LICENSE.GPL included in the packaging of this file. 
**
** or the
**  
**   Agreement for Purchase and Licensing
**
**   as offered by Software- und Organisations-Service GmbH
**   in the respective terms of supply that ship with this file.
**
** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
** IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
** THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
** PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
** BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
** CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
** SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
** INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
** CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
** ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
** POSSIBILITY OF SUCH DAMAGE.
********************************************************** end of preamble*/
//-->
    <style type="text/css">
      html          { overflow-y:scroll; overflow-x:auto; }
      body          { font-family:Arial,Helvetica,Sans-Serif;font-size:12px;background-color:#F6F6FF;margin:0px 8px; }
      code          { font-size:14px;color:crimson; }
      div.header    { font-family:"Trebuchet MS",Arial,Helvetica,Sans-Serif; font-size:18px; font-weight:bold; color:#EA7A14; text-align:center; white-space:nowrap; } 
      div.subheader { font-size:14px;width:100%;color:#808080;font-weight:bold; }
      div.calendar  { width:100%;color:#EA7A14; }
      td            { font-size:12px;background-color:#F6F6FF;vertical-align:top }
      th            { font-size:16px;background-color:#C0C0C0;color:white }
      table         { background-color:#808080; }
      select        { font-size:12px;width:60px; }
      option        { font-size:12px;padding-left:4px;padding-right:4px; } 
    </style>
    <script type="text/javascript" src="scheduler_init.js"></script>
    <script type="text/javascript" src="scheduler.js"></script>
    <script type="text/javascript" src="browser_dependencies.js"></script>
    <script type="text/javascript" src="prototype.js"></script>
    <script type="text/javascript" src="sos_logger.js"></script>
    <script type="text/javascript" language="javascript"><!--

var _scheduler;
var _calendar_params;
var _response = null;
var _at_nodes = new Array();

window.onload = function()
{   
    if( window.name == "" ) window.name = "scheduler_calendar";
    _scheduler = new Scheduler();
    
    if( !_calendar_params ) {
      try {
        _calendar_params  = window.opener.left_frame._calendar_params;
      } catch(E) {
        _calendar_params  = {'xml_command':'','menu':'scheduler','format':'html','job':'','order':''};;
      }
    }
    calendar_show();
}

window.onunload = function()
{
    if( _scheduler ) _scheduler.close();
}    
    
//-----------------------------------------------------------------------------calendar_show
    
function calendar_show()
{   
    var calendar_params = _calendar_params;
    try {
      var str = "";
      switch(calendar_params.menu) {
        case 'job_chain' : str  = getTranslation('job chain') + " <code>" + calendar_params.job + "</code>";
                           break;
        case 'job'       : str  = getTranslation('job') + " <code>" + calendar_params.job + "</code>";
                           break;
        case 'order'     : str  = getTranslation('order') + " <code>" + calendar_params.order + "</code> " + getTranslation('of job chain') + " <code>" + calendar_params.job + "</code>";
                           break;
        case 'scheduler' : str = (calendar_params.xml_command.search(/what=\'orders\'/) > -1) ? getTranslation('all jobs and orders') : getTranslation('all jobs');
                           break;
      }
      var output_options     = ['html','xml','csv'];
      var output_options_str = "";
      for( var i=0; i < output_options.length; i++ ) { 
        output_options_str += "<option value='"+output_options[i]+"' "+((calendar_params.format==output_options[i]) ? "selected='selected'" : "")+">"+output_options[i]+"</option>"; 
      }
      document.getElementById("header").innerHTML = "<nobr>" + getTranslation('Start times for') + " "+str+"</nobr><br /><nobr>" + getTranslation('by calling') + " <code>"+xml_encode(calendar_params.xml_command)+"</code></nobr><br /><nobr>" + getTranslation('with output format') + "&#160;&#160;<select size='1' onchange='get_output(this.value);'>"+output_options_str+"</select></nobr><hr noshade='noshade' size='1'/>";
      if( calendar_params.xml_command == "" ) {
        throw new Error( "unknown error - please close this window, reload the calling window and try it again" );
      }
      _scheduler.executeAsynchron( calendar_params.xml_command, calendar_show_callback, false, false, true );
      return true; 
    }
    catch( x ) {
      return show_error( x );
    }
}


//-----------------------------------------------------------------------------calendar_show_callback
    
function calendar_show_callback(response)
{   
    var calendar_params = _calendar_params;
    _response           = response;
    try { 
      if( !_response ) {
        throw new Error( "unknown error - please close this window, reload the calling window and try it again" );
      }
      
      var calendar_node = _response.selectSingleNode("/spooler/answer/calendar");
      _at_nodes     = calendar_node.selectNodes("at");
      
      if(calendar_params.menu != 'scheduler' ) {
        var ok = true;
        var removables = new Array();
        for( var i=0; i < _at_nodes.length; i++ ) {
          switch(calendar_params.menu) {
            case 'job_chain' : ok = (_at_nodes[i].getAttribute('job_chain') == calendar_params.job || '/'+_at_nodes[i].getAttribute('job_chain') == calendar_params.job);
                               break;
            case 'job'       : ok = (_at_nodes[i].getAttribute('job') == calendar_params.job || '/'+_at_nodes[i].getAttribute('job') == calendar_params.job);
                               break;
            case 'order'     : ok = ((_at_nodes[i].getAttribute('job_chain') == calendar_params.job || '/'+_at_nodes[i].getAttribute('job_chain') == calendar_params.job) && (_at_nodes[i].getAttribute('order') == calendar_params.order || '/'+_at_nodes[i].getAttribute('order') == calendar_params.order));
                               break;
          }
          if( !ok ) removables.push(_at_nodes[i]);
        }
        for( var i=0; i < removables.length; i++ ) { calendar_node.removeChild(removables[i]); }
        if( removables.length > 0 ) _at_nodes  = calendar_node.selectNodes("at");       
      }
      get_output(calendar_params.format);
      return true;
    }
    catch( x ) {
      return show_error( x );
    }
}


function get_output(format) { 
      switch(format) { 
        case 'html' : str  = '<table cellspacing="1" cellpadding="2" border="0" width="100%">';
                      str += '<colgroup><col width="16%" /><col width="28%" span="3" /></colgroup>';
                      str += '<tr><th>' + getTranslation("at") + '</th><th>' + getTranslation("job") + '</th><th>' + getTranslation("job chain") + '</th><th>' + getTranslation("order") + '</th></tr>';
                      for( var i=0; i < _at_nodes.length; i++ ) {
                        str += '<tr><td style="text-align:center">'+null2empty(_at_nodes[i].getAttribute('at')).replace(/T/g,' ')+'</td><td>'+null2empty(_at_nodes[i].getAttribute('job'))+'</td><td>'+null2empty(_at_nodes[i].getAttribute('job_chain'))+'</td><td>'+null2empty(_at_nodes[i].getAttribute('order'))+'</td></tr>';
                      }
                      str += '</table>';
                      document.getElementById("calendar").innerHTML = str;
                      break;
        case 'xml'  : document.getElementById("calendar").innerHTML = '<pre>'+xml_encode(_response.xml.replace(/\r/g,"").replace(/[ \t]*\n/g,"\n").replace(/\n{2,}/g,"\n").replace(/\t/g,"  "))+'</pre>';
                      break;
        case 'csv'  : str = '<pre>' + getTranslation("at") + ';' + getTranslation("job") + ';' + getTranslation("job chain") + ';' + getTranslation("order") + '\n';
                      for( var i=0; i < _at_nodes.length; i++ ) {
                        str += null2empty(_at_nodes[i].getAttribute('at')).replace(/T/g,' ')+';'+null2empty(_at_nodes[i].getAttribute('job'))+';'+null2empty(_at_nodes[i].getAttribute('job_chain'))+';'+null2empty(_at_nodes[i].getAttribute('order'))+'\n';
                      }
                      str += '</pre>';
                      document.getElementById("calendar").innerHTML = str; 
                      break;
      }
}


//---------------------------------------------------------------------------------------null2empty

function null2empty( str ) 
{
  return ( str == null || typeof str == 'undefined' ) ? '' : str;
}


//---------------------------------------------------------------------------------------xml_encode

function xml_encode( text )
{
    if( text == null )  return "";
    if( text.toString().search(/&(amp|lt|gt|quot|#039);/) > -1 ) return text;
    return text.toString().replace( /&/g, "&amp;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" ).replace( /\"/g, "&quot;" ).replace( /\'/g, "&#039;" );
}



//-----------------------------------------------------------------------------show_error

function show_error( x )
{
    var error_div = document.getElementById('error');
    if( error_div ) {
      error_div.style.display = "inline";
      error_div.innerHTML = x.message.replace( /&/g, "&amp;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" ).replace( /\"/g, "&quot;" ).replace( /\'/g, "&#039;" ).replace( /\n/g, "<br/>" ).replace( "  ", "\xA0 " );
    } else {
      alert( x.message );
    }
    return false;
}
  
//-->
    </script>
</head>
<body>
  <script language="javascript" type="text/javascript">  
    document.writeln( '  <div class="header"><img src="job_scheduler_rabbit_colour.gif" hspace="2" style="position:relative;top:1px" /><img src="job_scheduler_typo_colour.gif" hspace="2" /> - ' + getTranslation('CALENDAR') + '</div>' );
  </script>
  
  <div id="header" class="subheader"></div>
	<span id="error" style="color:red;display:none;padding-left:10px;padding-right:10px;"></span>
	<div id="calendar" class="calendar"></div>
</body>
</html>
