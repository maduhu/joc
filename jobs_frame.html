<!-- $Id: jobs_frame.html,v 1.15 2004/07/22 12:10:02 jz Exp $ -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta name="vs_targetSchema"    content="http://schemas.microsoft.com/intellisense/ie5"/>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>

    <title>Scheduler</title>

    <style type="text/css">
        @import "scheduler.css";
    </style>
</head>

<body>

<p style="background-color: #F0F0F0; margin-bottom: 10px; padding-top: 3px; padding-bottom: 3px">
    <input id="show_tasks_checkbox" type="checkbox" onclick="show_tasks_checkbox__onclick()" checked="true" NAME="show_tasks_checkbox"/>
    <label for="show_tasks_checkbox">Show running tasks</label>
    &#160; &#160;
    <input id="update_periodically_checkbox" type="checkbox" onclick="update_periodically_checkbox__onclick()" NAME="update_periodically_checkbox"/>
    <label for="update_periodically_checkbox">Update periodically</label>
    &#160; &#160;
    <input id="update_button" type="button" value="Update" onclick="update__onclick()" NAME="update_button"/>
</p>

<span id="error_message" style="font-weight: bold; color: red"></span>

<xml id="stylesheet" src="scheduler.xsl"></xml>

<script defer="true" type="text/javascript" src="scheduler.js"    ></script>
<script defer="true" type="text/javascript" src="popup_builder.js"></script>

<script type="text/javascript" for="window" event="onload"> do_onload(); </script>

<script defer="true" language="javascript"><!--
//-------------------------------------------------------------------------------------------------

var _stylesheet;
var _response;
var _timer;
var _scheduler;
//var _update_periodically = false;

//-------------------------------------------------------------------------------------------onload

function do_onload()
{
    _stylesheet = document.all.stylesheet.XMLDocument;
    if( _stylesheet.parseError.errorCode )  throw new Error( "Fehler im Stylesheet:\n" + _stylesheet.parseError.reason );

    
    document.all.stylesheet.outerHTML = "<span id='stylesheet'></span>";
    
    _scheduler = new Scheduler();
    //scheduler.execute_and_fill_html(  "<show_state what='all'/>" );

    repeat_update( document.all.update_periodically_checkbox.checked, true );
    
    //document.all.update_periodically_checkbox.checked = _update_periodically;
    scheduler_init();
}

//------------------------------------------------------------update_periodically_checkbox__onclick

function update_periodically_checkbox__onclick()
{
    reset_error();
    repeat_update( document.all.update_periodically_checkbox.checked, document.all.update_periodically_checkbox.checked );
}

//---------------------------------------------------------------------show_tasks_checkbox__onclick

function show_tasks_checkbox__onclick()
{
    reset_error();
    update();
}

//----------------------------------------------------------------------------------update__onclick

function update__onclick()
{
    reset_error();
    update();
}

//-----------------------------------------------------------------------scheduler_command__onclick

function scheduler_command__onclick()
{
    var popup_builder = new Popup_builder();
    
    var state = _response.selectSingleNode( "spooler/answer/state" ).getAttribute( "state" );
    
    var command = function( cmd ) { return "<modify_spooler cmd='" + cmd + "'/>"; }
    
    //popup_builder.add_entry  ( "Show log"                       , "parent.scheduler_command__show_log__onclick()" );
    popup_builder.add_show_log( "Show log"                       , "show_log", "show_log" );
    popup_builder.add_command ( "Stop"                           , command( "stop" ), state != "stopped"  &&  state != "stopping"  &&  state != "stopping_let_run" );
    popup_builder.add_command ( "Pause"                          , command( "pause"                         ), state != "paused" );
    popup_builder.add_command ( "Continue"                       , command( "continue"                      ), state == "paused" );
  //popup_builder.add_command ( "Reload"                         , command( "reload"                        ), state != "stopped"  &&  state != "stopping" );
    popup_builder.add_command ( "Terminate"                      , command( "terminate"                     ) );
    popup_builder.add_command ( "Terminate and restart"          , command( "terminate_and_restart"         ) );
    popup_builder.add_command ( "Let run, terminate and restart" , command( "let_run_terminate_and_restart" ) );
    popup_builder.add_command ( "Abort immediately"              , command( "abort_immediately"             ) );
    popup_builder.add_command ( "Abort immediately and restart"  , command( "abort_immediately_and_restart" ) );
    
    _popup = popup_builder.show_popup();
}

//-------------------------------------------------------------scheduler_command__show_log__onclick
/*
function scheduler_command__show_log__onclick()
{
    window.open( "http://" + document.location.host + "/show_log", "show_log", "", true );
    _popup.hide();
}
*/
//--------------------------------------------------------------------------------------reset_error

function reset_error()
{
    document.all.error_message.innerHTML = "";
    window.status = "";
}

//------------------------------------------------------------------------------------repeat_update

function repeat_update( repeat, call_update )
{
    reset_error();
    if( _timer != undefined )  window.clearTimeout( _timer ),  _timer = undefined;
    
    try
    {
        if( call_update )
        {
            document.all.update_periodically_checkbox.checked = false;     
            update();
        }
    }
    catch( x )
    {   
        repeat = false;
        var msg = "";
        
        if( typeof x == "object" )
        {
            if( x.number + 0xFFFFFFFF == 0x800C0004 )  repeat = true,  msg = "Connection to Scheduler lost<br/>";
            msg += "0x" + hex_string( x.number, 8 ) + "&#160; " + xml_encode( x.message );
            msg += "<p> </p>";
        }
        else
            msg = xml_encode( x );
            
        document.all.error_message.innerHTML = msg;
    }    

    if( repeat )
    {
        document.all.update_periodically_checkbox.checked = true;
        set_update_timer();
    }
}

//---------------------------------------------------------------------------------set_update_timer

function set_update_timer()
{
    if( _timer != undefined )  window.clearTimeout( _timer ),  _timer = undefined;
    _timer = window.setTimeout( "repeat_update(true,true)", 5000, "JavaScript" );
}

//--------------------------------------------------------------------------------update_jobs_frame

function update_jobs_frame()
{
    _response = _scheduler.execute( "<show_state what='all'/>" );
    modify_response( _response );
    document.all.stylesheet.innerHTML = _response.transformNode( _stylesheet );;
}

//-------------------------------------------------------------------------------------------update

function update()
{
    reset_error();
    update_jobs_frame();

    if( window.parent.details_frame.document.readyState == "complete" )
    {
        window.parent.details_frame.update();
    }
    
    if( _timer != undefined )  set_update_timer();
}

//----------------------------------------------------------------------------------modify_response

function modify_response( response )
{
    // Antwort manipulieren: <tasks> mit <task> auffüllen, bis <job tasks=".."> erreicht ist.

    var job_elements = response.selectNodes( ".//job" );
    for( var j = 0; j < job_elements.length; j++ )
    {
        var job_element = job_elements[j];
        
        var tasks_element = job_element.selectSingleNode( "tasks" );
        if( tasks_element )
        {
            var task_elements = tasks_element.selectNodes( "task" );
            var n = 1*job_element.getAttribute( "tasks" ) - task_elements.length;
            for( var t = 0; t < n; t++ )
            {
                tasks_element.appendChild( tasks_element.ownerDocument.createElement( "task" ) );
            }
        } 
    }
    
    
    // my_show_task einfügen
    
    var spooler_element = response.selectSingleNode( "spooler" );
    if( spooler_element )  spooler_element.setAttribute( "my_show_tasks", document.all.show_tasks_checkbox.checked? "yes" : "no" );
}

//--------------------------------------------------------------------------------show_task_details

function show_task_details( job_name, task_id )
{
    var job_element  = _response.selectSingleNode( ".//job[@job='" + job_name + "']" );
    var task_element = _response.selectSingleNode( ".//task[@id=" + task_id + "]" );

    update_jobs_frame();
    window.parent.details_frame.show_task_details( job_element, task_element );
}

//---------------------------------------------------------------------------------show_job_details

function show_job_details( job_name )
{
    var job_element  = _response.selectSingleNode( ".//job[@job='" + job_name + "']" );

    update_jobs_frame();
    window.parent.details_frame.show_job_details( job_element );
}

//-------------------------------------------------------------------------------------------------
--></script>

</body>

</html>
